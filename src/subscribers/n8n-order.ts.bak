import { 
  type SubscriberConfig, 
  type SubscriberArgs,
  OrderService,
} from "@medusajs/medusa"
import axios from "axios"

export default async function n8nOrderSubscriber({ 
  eventBusService, 
  orderService, 
  logger 
}: SubscriberArgs<any>) {

  // L'URL de votre webhook n8n
  const WEBHOOK_URL = "https://lionelauboin.app.n8n.cloud/webhook/medusa-order"

  // La fonction qui sera exécutée à chaque commande
  const handleOrderPlaced = async (data) => {
    try {
      // 1. On récupère l'ID de la commande depuis l'événement
      const orderId = data.id

      // 2. On charge la commande complète avec les relations nécessaires 
      // (items et shipping_address ne sont pas chargés par défaut pour les performances)
      const order = await orderService.retrieve(orderId, {
        relations: ["items", "shipping_address", "customer"],
      })

      // 3. On prépare le payload (Données à envoyer)
      const payload = {
        id: order.id,
        email: order.email,
        shipping_address: {
          first_name: order.shipping_address?.first_name,
          last_name: order.shipping_address?.last_name,
          address_1: order.shipping_address?.address_1,
          city: order.shipping_address?.city,
          postal_code: order.shipping_address?.postal_code,
          country_code: order.shipping_address?.country_code,
          phone: order.shipping_address?.phone
        },
        items: order.items.map(item => ({
          title: item.title,
          quantity: item.quantity,
          sku: item.variant?.sku, // Utile pour votre gestion de stock
          unit_price: item.unit_price / 100 // Conversion centimes -> euros
        })),
        total: order.total / 100, // Conversion centimes -> euros
        currency: order.currency_code,
        created_at: order.created_at
      }

      // 4. Envoi vers n8n
      await axios.post(WEBHOOK_URL, payload)
      
      logger.info(`✅ Webhook n8n envoyé pour la commande ${orderId}`)

    } catch (error) {
      logger.error(`❌ Échec du webhook n8n : ${error.message}`)
    }
  }

  // On abonne notre fonction à l'événement de création de commande
  return eventBusService.subscribe("order.placed", handleOrderPlaced)
}

export const config: SubscriberConfig = {
  event: "order.placed",
  context: {
    subscriberId: "n8n-order-subscriber",
  },
}
